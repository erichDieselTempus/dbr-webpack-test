<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
</head>

<body>
    <button id="readBarcode">show scanner CHANGED</button>
    <script src="./dist/bundle.js"></script>
    <script src="./src/scanLayer.js"></script>
    <div id = "masterGrid">
        <div id="left_sidebar" class="sidebar">
            
            <br>
            <label for="num_cols_input">Columns:</label>
            <input type="number" id="num_cols_input" min="0" max="10" onchange="redraw_overlay()">
            <label for="num_rows_input">Rows:</label>
            <input type="number" id="num_rows_input" min="0" max="10" onchange="redraw_overlay()">
            <br>
            <label for="x_length_input">X Length:</label>
            <input type="number" id="x_length_input" min="0" max="800" onchange="redraw_overlay()">
            <label for="y_length_input">Y Length:</label>
            <input type="number" id="y_length_input" min="0" max="800" onchange="redraw_overlay()">
            <br>
            <label for="x_gap_input">X Gap:</label>
            <input type="number" id="x_gap_input" min="0" max="1000" onchange="redraw_overlay()">
            <label for="y_gap_input">Y Gap:</label>
            <input type="number" id="y_gap_input" min="0" max="1000" onchange="redraw_overlay()">
            <br>
            <label for="x_offset_input">X Offset:</label>
            <input type="number" id="x_offset_input" min="0" max="1000" onchange="redraw_overlay()">
            <label for="y_offset_input">Y Offset:</label>
            <input type="number" id="y_offset_input" min="0" max="1000" onchange="redraw_overlay()">
            
        </div>
        <div id="div-ui-container">     
            <div class="dce-video-container"></div>
            <div id="overlay" onclick="check_grid_click(event)"></div>
        </div>
        <div id="right_sidebar" class="sidebar">
            <input type="button" value="CORNERS" onclick="load_overlay(this.value)">
            <input type="button" value="SIX-BY-FOUR" onclick="load_overlay(this.value)">
        </div>
    </div>
    
</body>
<script>
    const WIDTH = 800
    const HEIGHT = 450

    var x_offset_input = document.getElementById("x_offset_input")
    var y_offset_input = document.getElementById("y_offset_input")
    var num_cols_input = document.getElementById("num_cols_input")
    var num_rows_input = document.getElementById("num_rows_input")
    var x_gap_input = document.getElementById("x_gap_input")
    var y_gap_input = document.getElementById("y_gap_input")
    var x_length_input = document.getElementById("x_length_input")
    var y_length_input = document.getElementById("y_length_input")
    var overlay = document.getElementById("overlay")
    
    //init_overlay()

    //load_overlay("corners")


    function check_grid_click(event) {
        let result = ActiveSL.getCellIndexAt(event.offsetX, event.offsetY)
        if (result) {
            let regions = overlay.children[result - 1].classList.add('region_complete')
        }
        console.log(result)
    }
    function load_overlay(template_name) {
        let SL = new ScanLayer(template_name)
        ActiveSL = SL
        x_offset_input.value = SL.x_offset
        y_offset_input.value = SL.y_offset
        num_cols_input.value = SL.num_cols
        num_rows_input.value = SL.num_rows
        x_gap_input.value = SL.x_gap
        y_gap_input.value = SL.y_gap
        x_length_input.value = SL.cell_x
        y_length_input.value = SL.cell_y
        redraw_overlay()
    }

    /*

    function init_overlay() {
        x_offset_input.value = INIT_SIDE_MARGIN
        y_offset_input.value = INIT_TOP_MARGIN
        num_cols_input.value = INIT_NUM_COLS
        num_rows_input.value = INIT_NUM_ROWS
        grid_gap_input.value = INIT_GRID_GAP
        x_length_input.value = INIT_X_LENGTH
        y_length_input.value = INIT_Y_LENGTH
        refresh_y_offset()
        refresh_x_offset()
        refresh_grid()
        refresh_grid_gap()
        refresh_cell_size()
    }
    */

    function add_cells_to_overlay(rows, columns) {
        overlay.style.gridTemplateColumns = "repeat(" + columns.toString() + ", 1fr)"
        overlay.style.gridTemplateRows = "repeat(" + rows.toString() + ", 1fr)"
        for (let i=0;  i < rows*columns; i++) {
            console.log("loop")
            let br = document.createElement("div")
            br.classList.add('barcode_region');
            document.getElementById("overlay").appendChild(br)  
        }
    }

    function redraw_overlay() {
        // Set offset and grid gaps
        overlay.style.marginLeft = x_offset_input.value
        overlay.style.marginTop = y_offset_input.value
        let x_gap = x_gap_input.value.toString() + "px"
        let y_gap = y_gap_input.value.toString() + "px"
        // Grid gap takes <Row-gap> <Column-Gap>, so y_gap goes first
        overlay.style.gap = y_gap + " " + x_gap
        // Set grid template based on cell sizes.
        let num_cols = num_cols_input.value.toString()
        let num_rows = num_rows_input.value.toString()
        let x_size = x_length_input.value.toString() + "px"
        let y_size = y_length_input.value.toString() + "px"
        // repeat(N, 99px)
        overlay.style.gridTemplateColumns = "repeat(" + num_cols + "," + x_size + ")"
        overlay.style.gridTemplateRows = "repeat(" + num_rows + "," + y_size + ")"

        // Clear elements in the overlay
        while (overlay.hasChildNodes()) {
            overlay.removeChild(overlay.firstChild);
        }
        // Add new elements based on # of rows * columns
        for (let i=0;  i < num_rows*num_cols; i++) {
            let br = document.createElement("div")
            br.classList.add('barcode_region');
            document.getElementById("overlay").appendChild(br)  
        }
    }


    function refresh_cell_size() {
        let x_size = x_length_input.value.toString()
        let y_size = y_length_input.value.toString()
        // repeat(99px, N)
        overlay.style.gridTemplateColumns = "repeat(" + num_cols_input.value.toString() + "," + x_size + "px)"
        overlay.style.gridTemplateRows = "repeat(" + num_rows_input.value.toString() + "," + y_size + "px)"
    }

    function refresh_grid() {
        let num_rows = document.getElementById("num_rows_input").value
        let num_cols= document.getElementById("num_cols_input").value
        while (overlay.hasChildNodes()) {
            overlay.removeChild(overlay.firstChild);
        }
        add_cells_to_overlay(num_rows, num_cols)
    }

    function refresh_grid_gap() {
        overlay.style.gap = y_gap_input.value.toString() + "px " + x_gap_input.value.toString() + "px"
    }

    function refresh_y_offset() {
        let amt = y_offset_input.value
        overlay.style.height = HEIGHT - 2*amt
        overlay.style.marginTop = amt
        overlay.style.marbinBottom = amt
    }

    function refresh_x_offset() {
        overlay.style.marginLeft = x_offset_input.value
    }



</script>

<style>
    #masterGrid {
        height: 100%;
        display:grid;
        grid-template-columns: auto 800px auto;
        grid-template-rows: 1fr 1fr;
    }

    
    #div-ui-container {
        width: 100%;
        height: 100%;
        background-color: blue;

    }
    #overlay {
        display: grid;
        position: absolute;
        margin: 20px;
        width: 100%;
        height: 100%;
    }

    .dce-video-container {
        position: absolute;
        width: 800px;
        height: 450px;
        background-color: lightblue;
    }

    .sidebar {
        background-color: violet;
        justify-self: stretch;
    }
    .barcode_region {
        justify-self: stretch;
        border-style: solid;
        border-color: yellow;
        border-width: 5px;
        pointer-events: none;
    }

    .region_complete {
        border-color: black;
        background-color: rgba(128, 128, 0, 128a);
    }
    @media (max-width: 800px) {
        #div-ui-container {
            background-color: lime;
        }

        .dce-video-container {
            width: 400px;
            height: 225px;
            background-color: red;
        }
    }


</style>


</html>